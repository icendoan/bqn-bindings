libc â† â€¢Import "c.bqn"
path â† "/usr/lib64/libjansson.so"

FromPointer â‡ { ğ•Š ğ•©:
 obj â‡ ğ•©
 RawType â‡ { ğ•Šğ•©: obj â‰¡ 8â¥Š0 ? 7 ; âŠ‘ libc.MakeI32Vec âŸ¨1, objâŸ© }
 TypeOf â‡  { ğ•Šğ•©: (RawType obj) âŠ‘ ffi.types }

 Value â‡ { ğ•Šğ•©:
  accessor â† (RawType âŠ‘ âŸ¨readObject, readArray, readString, ffi.json_number_value, ffi.json_number_value, 1, 0, @âŸ©Ë™) obj
  Accessor obj
 }

 ReadArray â‡ { ğ•Š ğ•©:
  "JSON value is not an array" ! "array" â‰¡ TypeOf @
  n â† ffi.JSON_Array_Size obj
  {ğ•Šğ•©: o â† FromPointer ffi.JSON_Array_Get âŸ¨obj, ğ•©âŸ© â‹„ o.Value @ }Â¨ â†•n
 }

 ReadString â‡ { ğ•Šğ•©:
  "JSON value is not a string" ! "string" â‰¡ TypeOf @
  libc.From_CString ffi.JSON_String_Value obj
 }

 ReadObject â‡ { ğ•Šğ•©:
  "JSON value is not an object" ! "object" â‰¡ TypeOf @
  output â† âŸ¨âŸ©
  { ğ•Šiter:
   key â† libc.From_CString ffi.JSON_Object_Iter_Key iter
   value â† FromPointer ffi.JSON_Object_Iter_Value iter
   output â†© output âˆ¾ key â‹ˆ value.Value @
   ffi.JSON_Object_Iter_Next âŸ¨obj, iterâŸ©
  } â€¢_while_ {ğ•Šğ•©: ğ•© â‰¢ 8â¥Š0} ffi.JSON_Object_Iter obj
  âˆ˜â€¿2 â¥Š output
 }

 Get â‡ {
  ğ•Š key: "array" â‰¡ TypeOf @ ? FromPointer ffi.JSON_Array_Get âŸ¨obj, keyâŸ© ;
  ğ•Š key: "object" â‰¡ TypeOf @ ? FromPointer ffi.JSON_Object_Get âŸ¨obj, key âˆ¾ @âŸ© ;
  !Ëœ "JSON value was required to be object or array, but found " âˆ¾ TypeOf @ 
 }

 Set â‡ { 
  key ğ•Š value: "array" â‰¡ TypeOf @ ? ffi.JSON_Array_Set âŸ¨obj, key, valueâŸ© ;
  key ğ•Š value: "object" â‰¡ TypeOf @ ? ffi.JSON_Object_Set âŸ¨obj, key âˆ¾ @, valueâŸ© ;
  !Ëœ "JSON value was required to be object or array, but found " âˆ¾ TypeOf @
 }

 Append â‡ { ğ•Švalue:
  "Can only append to an array" ! "array" â‰¡ TypeOf @
  ffi.JSON_Array_Append âŸ¨obj, valueâŸ©
  ffi.JSON_Array_Size obj
 }

 Keys â‡ { ğ•Šğ•©: 
  "JSON value is not an object or an array" ! âŠ‘ (< TypeOf @) âˆŠ âŸ¨"array", "object"âŸ©
  (TypeOf @) ğ•Š ğ•© ;
 "object" ğ•Š ğ•©:
  k â† âŸ¨âŸ©
  { ğ•Š iter: k â†© k âˆ¾ <libc.From_CString ffi.JSON_Object_Iter_Key iter, ffi.JSON_Object_Iter_Next âŸ¨obj, iterâŸ©} â€¢_while_ {ğ•Šğ•©: ğ•© â‰¢ 8â¥Š0} ffi.JSON_Object_Iter obj
  k ;
  "array" ğ•Š ğ•©: â†• ffi.JSON_Array_Size obj ;
  ğ•¨ ğ•Š ğ•©: !Ëœ "JSON value is not an object or an array"
 }

 Values â‡ {
  ğ•Šğ•©: (TypeOf @) ğ•Š ğ•©;
  "array" ğ•Š ğ•©: ReadArray ğ•© ;
  "object" ğ•Š ğ•©:
   v â† âŸ¨âŸ©
   { ğ•Š iter: v â†© v âˆ¾ < (FromPointer ffi.JSON_Object_Iter_Value iter).Value @, ffi.JSON_Object_Iter_Next âŸ¨obj, iterâŸ©} â€¢_while_ {ğ•Šğ•©: ğ•©â‰¢8â¥Š0} ffi.JSON_Object_Iter obj
   v ;
   ğ•¨ğ•Šğ•©: Value @
 }

 Copy â‡ { ğ•Šğ•©: FromPointer ffi.JSON_Copy obj }
 DeepCopy â‡ { ğ•Šx: FromPointer ffi.JSON_Deep_Copy obj }
 Destroy â‡ {ğ•Šğ•©:
  # this can't actually decrement ref counts, since those are macros and not functions to call
  # todo: handle refcounting properly for these objects
  "Cannot destroy a null object" ! obj â‰¢ 8â¥Š0 
  count â† 2 âŠ‘ libc.MakeI32Vec âŸ¨3, objâŸ© # probably not more than 2â‹†32 references...
  count â‰¡ 1 ? { ffi.JSON_Delete obj â‹„ obj â†© 8â¥Š0 â‹„ @ } ; @
 }
}

Parse â‡ { ğ•Š text:
  FromPointer ffi.Json_LoadB âŸ¨text, â‰ text, ffi.flags.default, 8â¥Š0âŸ© # todo: error reporting
}

Read â‡ { ğ•Š path:
 FromPointer ffi.Json_Load_File âŸ¨path âˆ¾ @, ffi.flags.default, 8â¥Š0âŸ© # todo: error reporting
}

FromString â‡ { ğ•Šğ•©: FromPointer ffi.JSON_StringN âŸ¨ğ•©, â‰ ğ•©âŸ©}
FromNumber â‡ { ğ•Šğ•©: FromPointer ffi.JSON_Real ğ•© }
CreateArray â‡ { ğ•Šğ•©: FromPointer ffi.JSON_Array @ } 
CreateObject â‡ { ğ•Šğ•©: FromPointer ffi.JSON_Object @ }

ffi â‡ {
 string â† "*u8:c8"
 json_t_ptr â† "*:i8" # struct { type: i32, refcount: u64 }
 opaque_ptr â† "*:i8"

 flags â‡ {
   reject_duplicates â‡ 1
   disable_eof_check â‡ 2
   decode_any â‡ 4
   decode_int_as_real â‡ 8
   allow_nul â‡ 16
   default â‡ 31 # default to setting everything
 }

 types â‡ âŸ¨"object", "array", "string", "integer", "real", "true", "false", "null"âŸ©
 
 #json_incref â‡ path â€¢FFI âŸ¨json_t_ptr, "json_incref", '>' âˆ¾ json_t_ptrâŸ©
 #json_decref â‡ path â€¢FFI âŸ¨"", "json_decref", '>' âˆ¾ json_t_ptrâŸ©
 json_true â‡ path â€¢FFI âŸ¨json_t_ptr, "json_true"âŸ©
 json_false â‡ path â€¢FFI âŸ¨json_t_ptr, "json_false"âŸ©
 json_null â‡ path â€¢FFI âŸ¨json_t_ptr, "json_null"âŸ©

 json_string â‡ path â€¢FFI âŸ¨json_t_ptr, "json_string", stringâŸ©
 json_stringn â‡ path â€¢FFI âŸ¨json_t_ptr, "json_stringn", string, "i32"âŸ©
 json_string_value â‡ path â€¢FFI âŸ¨"*:i8", "json_string_value", '>' âˆ¾ json_t_ptrâŸ©
 json_string_set â‡ path â€¢FFI âŸ¨"i32", "json_string_set", json_t_ptr, stringâŸ©
 json_string_setn â‡ path â€¢FFI âŸ¨"i32", "json_string_setn", json_t_ptr, string, "i32"âŸ©

 json_integer â‡ path â€¢FFI âŸ¨json_t_ptr, "json_integer", ">i64"âŸ©
 json_integer_value â‡ path â€¢FFI âŸ¨"i64", "json_integer_value", '>' âˆ¾ json_t_ptrâŸ©
 json_integer_set â‡ path â€¢FFI âŸ¨"i32", "json_integer_set", json_t_ptr, "i64"âŸ©

 json_real â‡ path â€¢FFI âŸ¨json_t_ptr, "json_real", ">f64"âŸ©
 json_real_value â‡ path â€¢FFI âŸ¨"f64", "json_real_value", '>' âˆ¾ json_t_ptrâŸ©
 json_number_value â‡ path â€¢FFI âŸ¨"f64", "json_number_value", '>' âˆ¾ json_t_ptrâŸ©
 json_real_set â‡ path â€¢FFI âŸ¨"i32", "json_real_set", json_t_ptr, "f64"âŸ©

 json_array â‡ path â€¢FFI âŸ¨json_t_ptr, "json_array"âŸ©
 json_array_size â‡ path â€¢FFI âŸ¨"u64", "json_array_size", '>' âˆ¾ json_t_ptrâŸ©
 json_array_get â‡ path â€¢FFI âŸ¨json_t_ptr, "json_array_get", json_t_ptr, "u64"âŸ©
 # this is static INLINE in the C, so not exported...
 #json_array_set â‡ path â€¢FFI âŸ¨"i32", "json_array_set", json_t_ptr, "u64", json_t_ptrâŸ©
 json_array_set_new â‡ path â€¢FFI âŸ¨"i32", "json_array_set_new", json_t_ptr, "u64", json_t_ptrâŸ©
 json_array_set â‡ json_array_set_new
 #json_array_append â‡ path â€¢FFI âŸ¨"i32", "json_array_append", json_t_ptr, json_t_ptrâŸ©
 json_array_append_new â‡ path â€¢FFI âŸ¨"i32", "json_array_append_new", json_t_ptr, json_t_ptrâŸ©
 json_array_append â‡ json_array_append_new
 #json_array_insert â‡ path â€¢FFI âŸ¨"i32", "json_array_insert", json_t_ptr, "u64", json_t_ptrâŸ©
 json_array_insert_new â‡ path â€¢FFI âŸ¨"i32", "json_array_insert_new", json_t_ptr, "u64", json_t_ptrâŸ©
 json_array_insert â‡ json_array_insert_new
 json_array_remove â‡ path â€¢FFI âŸ¨"i32", "json_array_remove", json_t_ptr, "u64"âŸ©
 json_array_clear â‡ path â€¢FFI âŸ¨"i32", "json_array_clear", '>' âˆ¾ json_t_ptrâŸ©
 json_array_extend â‡ path â€¢FFI âŸ¨"i32", "json_array_extend", json_t_ptr, json_t_ptrâŸ©

 json_object â‡ path â€¢FFI âŸ¨json_t_ptr, "json_object"âŸ©
 json_object_size â‡ path â€¢FFI âŸ¨"u64", "json_object_size", '>' âˆ¾ json_t_ptrâŸ©
 json_object_get â‡ path â€¢FFI âŸ¨json_t_ptr, "json_object_get", json_t_ptr, stringâŸ©
 #json_object_set â‡ path â€¢FFI âŸ¨"i32", "json_object_set", json_t_ptr, string, json_t_ptrâŸ©
 json_object_set_new â‡ path â€¢FFI âŸ¨"i32", "json_object_set_new", json_t_ptr, string, json_t_ptrâŸ©
 json_object_set â‡ json_object_set_new
 #json_object_set_nocheck â‡ path â€¢FFI âŸ¨"i32", "json_object_set_nocheck", json_t_ptr, string, json_t_ptrâŸ©
 #json_object_set_new_nocheck â‡ path â€¢FFI âŸ¨"i32", "json_object_set_new_nocheck", json_t_ptr, string, json_t_ptrâŸ©
 json_object_del â‡ path â€¢FFI âŸ¨"i32", "json_object_del", json_t_ptr, stringâŸ©
 json_object_clear â‡ path â€¢FFI âŸ¨"i32", "json_object_clear", '>' âˆ¾ json_t_ptrâŸ©
 json_object_update â‡ path â€¢FFI âŸ¨"i32", "json_object_update", json_t_ptr, json_t_ptrâŸ©
 json_object_update_existing â‡ path â€¢FFI âŸ¨"i32", "json_object_update_existing", json_t_ptr, json_t_ptrâŸ©
 json_object_update_missing â‡ path â€¢FFI âŸ¨"i32", "json_object_update_missing", json_t_ptr, json_t_ptrâŸ©

 json_object_iter â‡ path â€¢FFI âŸ¨opaque_ptr, "json_object_iter", '>' âˆ¾ json_t_ptrâŸ©
 json_object_iter_next â‡ path â€¢FFI âŸ¨opaque_ptr, "json_object_iter_next", json_t_ptr, opaque_ptrâŸ©
 json_object_iter_key â‡ path â€¢FFI âŸ¨opaque_ptr, "json_object_iter_key", '>' âˆ¾ opaque_ptrâŸ©
 json_object_iter_value â‡ path â€¢FFI âŸ¨json_t_ptr, "json_object_iter_value", '>' âˆ¾ opaque_ptrâŸ©
 #json_object_iter_set â‡ path â€¢FFI âŸ¨"i32", "json_object_iter_set", json_t_ptr, opaque_ptr, json_t_ptrâŸ©
 json_object_iter_set_new â‡ path â€¢FFI âŸ¨"i32", "json_object_iter_set_new", json_t_ptr, opaque_ptr, json_t_ptrâŸ©
 json_object_iter_set â‡ json_object_iter_set_new

 json_dumps â‡ path â€¢FFI âŸ¨string, "json_dumps", json_t_ptr, "u64"âŸ©
 json_dump_file â‡ path â€¢FFI âŸ¨"i32", "json_dump_file", json_t_ptr, string, "u64"âŸ©

 json_loads â‡ path â€¢FFI âŸ¨json_t_ptr, "json_loads", string, "u64", opaque_ptrâŸ©
 json_loadb â‡ path â€¢FFI âŸ¨json_t_ptr, "json_loadb", string, "u64", "u64", opaque_ptrâŸ©
 json_load_file â‡ path â€¢FFI âŸ¨json_t_ptr, "json_load_file", string, "u64", opaque_ptrâŸ©

 json_copy â‡ path â€¢FFI âŸ¨json_t_ptr, "json_copy", '>' âˆ¾ json_t_ptrâŸ©
 json_deep_copy â‡ path â€¢FFI âŸ¨json_t_ptr, "json_deep_copy", '>' âˆ¾ json_t_ptrâŸ©
 json_delete â‡ path â€¢FFI âŸ¨"", "json_delete", '>' âˆ¾ json_t_ptrâŸ©
}
