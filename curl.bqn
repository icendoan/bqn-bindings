libc â† â€¢Import "c.bqn"
path â† "/usr/lib64/libcurl.so"

# Corresponds to the CURLoptions enum
options â‡ {
  # there are *many* missing here, but this gets the job done right now
  verbose â‡ 41
  write_data â‡ 10001
  url â‡ 10002
}

Get â‡ {
ğ•Š url:
 ("/tmp/bqn-curl-" âˆ¾ (âˆ¾ â€¢FmtÂ¨ | â€¢Hash url) âˆ¾ â€¢Fmt â€¢UnixTime @) ğ•Š url;

file ğ•Š url:
 #handle â† ffi.Curl_Easy_Init @
 ffi.Curl_Easy_Setopt_Str âŸ¨handle, options.url, url âˆ¾ @âŸ©
 file_ptr â† libc.FOpen âŸ¨file âˆ¾ @, "w+" âˆ¾ @âŸ©
 ffi.Curl_Easy_Setopt_Ptr âŸ¨handle, options. write_data, file_ptrâŸ©
 ffi.Curl_Easy_Perform handle
 #ffi.Curl_Easy_Cleanup handle
 libc.FClose file_ptr
 â€¢file.Chars file
}

# The raw FFI calls, bound to their C name
ffi â‡ {
  # common types
  opaque_ptr â† "*:i8"
  string â† "*u8:c8"

  curl_easy_init â‡ path â€¢FFI âŸ¨opaque_ptr, "curl_easy_init"âŸ©

  # the curl_easy_setopt function uses varargs, so overload the common types here
  curl_easy_setopt_int â‡ path â€¢FFI âŸ¨"i32", "curl_easy_setopt", opaque_ptr, "i32", "i32"âŸ©
  curl_easy_setopt_str â‡ path â€¢FFI âŸ¨"i32", "curl_easy_setopt", opaque_ptr, "i32", stringâŸ©
  # For use with string pointers, like that from curl_easy_escape
  curl_easy_setopt_ptr â‡ path â€¢FFI âŸ¨"i32", "curl_easy_setopt", opaque_ptr, "i32", opaque_ptrâŸ©
  curl_easy_setopt_long â‡ path â€¢FFI âŸ¨"i32", "curl_easy_setopt", opaque_ptr, "i32", "u64"âŸ©

  curl_easy_perform â‡ path â€¢FFI âŸ¨"i32", "curl_easy_perform", '>' âˆ¾ opaque_ptrâŸ©

  curl_easy_cleanup â‡ path â€¢FFI âŸ¨"", "curl_easy_cleanup", '>' âˆ¾ opaque_ptrâŸ©

  curl_easy_escape â‡ path â€¢FFI âŸ¨opaque_ptr, "curl_easy_escape", opaque_ptr, string, "i32"âŸ©

  curl_free â‡ path â€¢FFI âŸ¨"", "curl_free", '>' âˆ¾ opaque_ptrâŸ©
}

handle â‡ ffi.Curl_Easy_Init @
